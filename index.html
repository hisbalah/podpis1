<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Plná moc – podpis (v12)</title>
<style>
  :root{ --brand:#0a58ff; }
  *{ box-sizing:border-box }
  body{ font-family:system-ui, Arial, sans-serif; margin:16px; color:#111 }
  .btn{ display:inline-block; padding:12px 16px; border-radius:10px; border:1px solid #d0d7ff; background:#eef3ff; color:#0a2cff; cursor:pointer; font-weight:700; margin-top:12px }
  .btn.primary{ background:var(--brand); border-color:var(--brand); color:#fff }
  .btn.ghost{ background:#fff; border-color:#ccc; color:#333 }
  .card{ border:1px solid #e5e7eb; border-radius:14px; padding:14px; background:#fff; margin-bottom:12px }
  .hidden{ display:none !important }
  label{ display:block; font-weight:600; margin:10px 0 6px }
  input{ width:100%; padding:12px; border:1px solid #c9c9c9; border-radius:10px; font-size:16px }
  input:focus{ outline:2px solid #bcd3ff; }
  #pdfEmbed{ width:100%; height:540px; border:1px solid #d1d5db; border-radius:10px }
  #pdfCanvas, #filledCanvas{ width:100%; height:auto; border:1px solid #d1d5db; border-radius:10px }
  #resultFrame, #finalFrame{ width:100%; height:560px; border:1px solid #333; border-radius:10px }
  /* Signature panel (custom engine, multi-stroke, SVG path export) */
  #sigPanel{ position:fixed; left:0; right:0; bottom:0; top:0; background:rgba(0,0,0,.25); display:none; align-items:center; justify-content:center; z-index:9999; padding:10px }
  #sigBox{ width:min(960px, 96vw); background:#fff; border-radius:14px; box-shadow:0 12px 40px rgba(0,0,0,.25); padding:12px; display:flex; flex-direction:column; gap:10px }
  #sigHeader{ display:flex; align-items:center; justify-content:space-between }
  #sigCanvasWrap{ border:1px dashed var(--brand); border-radius:10px; position:relative; padding:8px }
  #sigCanvas{ width:100%; height:260px; display:block; touch-action:none; background:#fff }
  .sigLine{ position:absolute; left:5%; right:5%; bottom:22px; border-bottom:3px solid #000; opacity:.5; pointer-events:none }
  #sigFooter{ display:flex; gap:10px; justify-content:flex-end }
  /* Mobile keyboard safe area */
  @media (max-width: 768px){
    body{ padding-bottom: 120px; }
    .floating-actions{ position:sticky; bottom:0; background:#fff; padding:8px 0 }
  }
</style>
</head>
<body>

<!-- 1) PDF preview (desktop embed, mobile PDF.js) -->
<div class="card">
  <div id="desktopPreview">
    <embed id="pdfEmbed" src="template.pdf" type="application/pdf">
  </div>
  <div id="mobilePreview" class="hidden">
    <canvas id="pdfCanvas"></canvas>
  </div>
  <div class="floating-actions"><button id="btnStartFill" class="btn primary">Vyplniť údaje</button></div>
</div>

<!-- 2) Form (hidden until clicked) -->
<div id="formCard" class="card hidden">
  <div>
    <label for="i_name">Meno a priezvisko</label>
    <input id="i_name" placeholder="Ján Novák" inputmode="text">
  </div>
  <div>
    <label for="i_addr">Trvalý pobyt</label>
    <input id="i_addr" placeholder="Ulica 1, 010 01 Mesto" inputmode="text">
  </div>
  <div>
    <label for="i_rc">Rodné číslo</label>
    <input id="i_rc" placeholder="XXXXXX/XXXX" inputmode="numeric">
  </div>
  <div style="display:flex; gap:10px">
    <div style="flex:1">
      <label for="i_place">Miesto podpísania</label>
      <input id="i_place" placeholder="Bratislava" inputmode="text">
    </div>
    <div style="flex:1">
      <label for="i_date">Dátum</label>
      <input id="i_date" type="date">
    </div>
  </div>
  <div>
    <label for="i_client_email">Email klienta (voliteľné – po podpise pošleme PDF)</label>
    <input id="i_client_email" placeholder="email@example.com" inputmode="email">
  </div>
  <div class="floating-actions">
    <button id="btnConfirmForm" class="btn primary">Potvrdiť údaje (zobraziť vyplnené PDF)</button>
  </div>
</div>

<!-- 3) Filled PDF (same page, no new tab) -->
<div id="filledCard" class="card hidden">
  <div id="filledDesktop">
    <iframe id="resultFrame"></iframe>
  </div>
  <div id="filledMobile" class="hidden">
    <canvas id="filledCanvas"></canvas>
  </div>
  <div style="display:flex; gap:10px; margin-top:10px" class="floating-actions">
    <button id="btnSign" class="btn primary">Podpísať</button>
    <a id="btnDownloadFilled" class="btn ghost hidden" download="plna_moc_vyplnena.pdf">Stiahnuť vyplnené PDF</a>
  </div>
</div>

<!-- 4) Signature panel -->
<div id="sigPanel">
  <div id="sigBox">
    <div id="sigHeader">
      <div><strong>Podpis</strong> – nakreslite na čiaru</div>
      <button id="btnCloseSig" class="btn ghost">Zavrieť</button>
    </div>
    <div id="sigCanvasWrap">
      <div class="sigLine"></div>
      <canvas id="sigCanvas"></canvas>
    </div>
    <div id="sigFooter">
      <button id="btnUndoStroke" class="btn ghost">Späť (krok)</button>
      <button id="btnClearSig" class="btn ghost">Vymazať všetko</button>
      <button id="btnConfirmSig" class="btn primary">Potvrdiť podpis</button>
    </div>
  </div>
</div>

<!-- 5) Final PDF (same page, no pdf.js render to avoid stack) -->
<div id="finalCard" class="card hidden">
  <div id="finalDesktop">
    <iframe id="finalFrame"></iframe>
  </div>
  <div style="margin-top:10px">
    <a id="btnDownloadFinal" class="btn primary" download="plna_moc_podpisana.pdf">Stiahnuť podpísané PDF</a>
  </div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
<script>
  // --- EmailJS ---
  emailjs.init("BDiw7IJQiDnlCYFPX");
  const EMAIL_SERVICE_ID = "service_gnniw7e";
  const EMAIL_TEMPLATE_ID = "template_184peha";
  const AGENT_EMAIL      = "m.sunok@protonmail.com";

  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

  const desktopPreview = document.getElementById('desktopPreview');
  const mobilePreview  = document.getElementById('mobilePreview');
  const pdfCanvas      = document.getElementById('pdfCanvas');

  const formCard  = document.getElementById('formCard');
  const filledCard= document.getElementById('filledCard');
  const resultFrame = document.getElementById('resultFrame');
  const filledCanvas= document.getElementById('filledCanvas');

  const finalCard = document.getElementById('finalCard');
  const finalFrame= document.getElementById('finalFrame');
  const btnDownloadFinal  = document.getElementById('btnDownloadFinal');

  const btnStartFill = document.getElementById('btnStartFill');
  const btnConfirmForm = document.getElementById('btnConfirmForm');
  const btnSign = document.getElementById('btnSign');
  const btnDownloadFilled = document.getElementById('btnDownloadFilled');

  if (isMobile) {
    desktopPreview.classList.add('hidden');
    mobilePreview.classList.remove('hidden');
    renderPdfToCanvas('template.pdf', pdfCanvas);
  }

  let filledPdfBytes = null;
  let finalPdfBytes  = null;

  function xhrLoadArrayBuffer(url){
    return new Promise((resolve, reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open("GET", url);
      xhr.responseType = "arraybuffer";
      xhr.onload = ()=> resolve(xhr.response);
      xhr.onerror = ()=> reject(new Error("XHR PDF load failed"));
      xhr.send();
    });
  }
  function blobUrl(bytes){ return URL.createObjectURL(new Blob([bytes], {type:"application/pdf"})); }
  function bytesToDataUrl(bytes){
    return new Promise(resolve=>{
      const blob = new Blob([bytes], {type:"application/pdf"});
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  }
  async function renderPdfToCanvas(srcOrBytes, canvas){
    const loadingTask = (typeof srcOrBytes === 'string')
      ? pdfjsLib.getDocument(srcOrBytes)
      : pdfjsLib.getDocument({ data: srcOrBytes });
    const pdf = await loadingTask.promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 1.4 });
    const context = canvas.getContext('2d');
    canvas.width  = viewport.width;
    canvas.height = viewport.height;
    await page.render({ canvasContext: context, viewport }).promise;
  }

  // Prevent keyboard covering inputs on mobile
  const inputs = Array.from(document.querySelectorAll('input'));
  inputs.forEach(inp=>{
    inp.addEventListener('focus', ()=>{
      setTimeout(()=> inp.scrollIntoView({behavior:'smooth', block:'center'}), 150);
    });
  });

  btnStartFill.addEventListener('click', ()=>{
    formCard.classList.remove('hidden');
    window.scrollTo({ top: formCard.offsetTop - 8, behavior: 'smooth' });
  });

  btnConfirmForm.addEventListener('click', async ()=>{
    try{
      const existingPdfBytes = await xhrLoadArrayBuffer('template.pdf');

      const { PDFDocument, StandardFonts } = PDFLib;
      const pdfDoc = await PDFDocument.load(existingPdfBytes);
      const page = pdfDoc.getPages()[0];
      const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
      function draw(text, x, y){ page.drawText(text||'', { x, y, size: 11, font }); }

      const name  = document.getElementById('i_name').value;
      const addr  = document.getElementById('i_addr').value;
      const rc    = document.getElementById('i_rc').value;
      const place = document.getElementById('i_place').value;
      const date  = document.getElementById('i_date').value;

      // VARIANTA B – odhad súradníc, doladíme spolu
      draw(name,  160, 675);
      draw(addr,  160, 655);
      draw(rc,    160, 635);
      draw(place, 160, 515);
      if (date){
        const p = date.split('-');
        draw(p[2]+'.'+p[1]+'.'+p[0], 305, 515);
      }

      filledPdfBytes = await pdfDoc.save();
      if (isMobile) {
        document.getElementById('filledMobile').classList.remove('hidden');
        document.getElementById('filledDesktop').classList.add('hidden');
        await renderPdfToCanvas(filledPdfBytes, filledCanvas);
      } else {
        const url = blobUrl(filledPdfBytes);
        resultFrame.src = url;
        btnDownloadFilled.href = url;
      }
      btnDownloadFilled.classList.remove('hidden');
      filledCard.classList.remove('hidden');
      window.scrollTo({ top: filledCard.offsetTop - 8, behavior: 'smooth' });
    }catch(e){
      alert('Chyba pri generovaní vyplneného PDF: ' + e.message);
    }
  });

  // ==== Custom multi-stroke signature with SVG path export ====
  const sigPanel   = document.getElementById('sigPanel');
  const sigCanvas  = document.getElementById('sigCanvas');
  const btnCloseSig= document.getElementById('btnCloseSig');
  const btnClearSig= document.getElementById('btnClearSig');
  const btnUndo    = document.getElementById('btnUndoStroke');
  const btnConfirmSig = document.getElementById('btnConfirmSig');

  let sctx = null;
  let drawing = false;
  let strokes = []; // array of arrays of points
  let current = [];

  function initSigCanvas(){
    sctx = sigCanvas.getContext('2d');
    const cssW = Math.floor(document.getElementById('sigCanvasWrap').clientWidth - 16);
    const cssH = 260;
    sigCanvas.width  = 600; // fixed tiny internal res
    sigCanvas.height = 240;
    sigCanvas.style.width  = cssW + 'px';
    sigCanvas.style.height = cssH + 'px';
    sctx.setTransform(1,0,0,1,0,0);
    sctx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
    sctx.lineCap = 'round';
    sctx.lineJoin = 'round';
    sctx.strokeStyle = '#0a58ff';
    sctx.lineWidth = 4.2;
    strokes = [];
    current = [];
  }

  function scaleCoord(e){
    const p = (e.touches ? e.touches[0] : e);
    const rect = sigCanvas.getBoundingClientRect();
    const x = (p.clientX - rect.left) * (sigCanvas.width  / rect.width);
    const y = (p.clientY - rect.top)  * (sigCanvas.height / rect.height);
    return {x,y};
  }

  function drawAll(){
    sctx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
    function drawStroke(pts){
      if(pts.length<2) return;
      sctx.beginPath();
      sctx.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length-1;i++){
        const xc=(pts[i].x+pts[i+1].x)/2, yc=(pts[i].y+pts[i+1].y)/2;
        sctx.quadraticCurveTo(pts[i].x, pts[i].y, xc, yc);
      }
      sctx.stroke();
    }
    strokes.forEach(drawStroke);
    drawStroke(current);
  }

  function onDown(e){ e.preventDefault(); drawing=true; current=[]; current.push(scaleCoord(e)); drawAll(); }
  function onMove(e){ if(!drawing) return; e.preventDefault(); current.push(scaleCoord(e)); if(current.length>1200) current=current.slice(-1200); drawAll(); }
  function onUp(e){ if(!drawing) return; e.preventDefault(); drawing=false; if(current.length>1){ strokes.push(current.slice()); } current=[]; drawAll(); }

  function attachSigEvents(){
    sigCanvas.addEventListener('mousedown', onDown, {passive:false});
    sigCanvas.addEventListener('mousemove', onMove, {passive:false});
    document.addEventListener('mouseup', onUp, {passive:false});
    sigCanvas.addEventListener('touchstart', onDown, {passive:false});
    sigCanvas.addEventListener('touchmove', onMove, {passive:false});
    sigCanvas.addEventListener('touchend', onUp, {passive:false});
  }

  document.getElementById('btnSign').addEventListener('click', ()=>{
    sigPanel.style.display = 'flex';
    initSigCanvas();
    attachSigEvents();
  });
  btnCloseSig.addEventListener('click', ()=>{ sigPanel.style.display = 'none'; });
  btnClearSig.addEventListener('click', ()=>{ strokes=[]; current=[]; drawAll(); });
  btnUndo.addEventListener('click', ()=>{ strokes.pop(); drawAll(); });

  function buildSvgPathFromStrokes(){
    // Flip Y because PDF coords grow upward; canvas/SVG downward
    const h = sigCanvas.height;
    let d = '';
    for(const pts of strokes){
      if(pts.length<2) continue;
      const p0 = pts[0];
      d += `M ${p0.x.toFixed(2)} ${(h-p0.y).toFixed(2)} `;
      for(let i=1;i<pts.length-1;i++){
        const p = pts[i], n=pts[i+1];
        const xc=(p.x+n.x)/2, yc=(p.y+n.y)/2;
        d += `Q ${p.x.toFixed(2)} ${(h-p.y).toFixed(2)} ${xc.toFixed(2)} ${(h-yc).toFixed(2)} `;
      }
    }
    return d || 'M 0 0';
  }

  btnConfirmSig.addEventListener('click', async ()=>{
    try{
      if(strokes.length===0){ alert('Podpis chýba.'); return; }
      const { PDFDocument, rgb } = PDFLib;
      const pdfDoc = await PDFDocument.load(filledPdfBytes);
      const page = pdfDoc.getPages()[0];

      // SVG path signature (vector) – zero images, zero base64, no stack issues
      const path = buildSvgPathFromStrokes();
      // Our canvas internal is 600 wide -> scale to ~185 target width
      const scale = 185 / 600;
      page.drawSvgPath(path, {
        x: 365,
        y: 458,
        scale: scale,
        borderColor: rgb(0.04, 0.35, 1.0), // modrá
        borderWidth: 1.8
      });

      finalPdfBytes = await pdfDoc.save();

      const url = blobUrl(finalPdfBytes);
      finalFrame.src = url;
      btnDownloadFinal.href = url;
      finalCard.classList.remove('hidden');
      sigPanel.style.display = 'none';
      window.scrollTo({ top: finalCard.offsetTop - 8, behavior: 'smooth' });

      // Emails (async, non-blocking)
      const dataUrl = await bytesToDataUrl(finalPdfBytes);
      const base64 = dataUrl.split(',')[1] || '';
      const params = {
        client_email: (document.getElementById('i_client_email').value || '').trim(),
        agent_email:  "m.sunok@protonmail.com",
        pdf_file:     base64,
        client_name:  document.getElementById('i_name').value
      };
      setTimeout(()=>{ emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, params).catch(()=>{}); }, 0);
    }catch(e){
      alert('Chyba pri finálnom podpise: ' + e.message);
    }
  });
</script>
</body>
</html>
