<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plná moc – podpis (v11.1)</title>
<style>
  :root{ --brand:#0a58ff; }
  *{ box-sizing:border-box }
  body{ font-family:system-ui, Arial, sans-serif; margin:16px; color:#111 }
  .btn{ display:inline-block; padding:12px 16px; border-radius:10px; border:1px solid #d0d7ff; background:#eef3ff; color:#0a2cff; cursor:pointer; font-weight:700; margin-top:12px }
  .btn.primary{ background:var(--brand); border-color:var(--brand); color:#fff }
  .btn.ghost{ background:#fff; border-color:#ccc; color:#333 }
  .card{ border:1px solid #e5e7eb; border-radius:14px; padding:14px; background:#fff; margin-bottom:12px }
  .hidden{ display:none !important }
  label{ display:block; font-weight:600; margin:10px 0 6px }
  input{ width:100%; padding:10px; border:1px solid #c9c9c9; border-radius:8px; font-size:16px }
  #pdfEmbed{ width:100%; height:540px; border:1px solid #d1d5db; border-radius:10px }
  #pdfCanvas, #finalCanvas, #filledCanvas{ width:100%; height:auto; border:1px solid #d1d5db; border-radius:10px }
  #resultFrame, #finalFrame{ width:100%; height:560px; border:1px solid #333; border-radius:10px }
  /* Signature panel (custom engine) */
  #sigPanel{ position:fixed; left:0; right:0; bottom:0; top:0; background:rgba(0,0,0,.2); display:none; align-items:center; justify-content:center; z-index:9999 }
  #sigBox{ width:min(960px, 96vw); background:#fff; border-radius:14px; box-shadow:0 12px 40px rgba(0,0,0,.25); padding:12px; display:flex; flex-direction:column; gap:10px }
  #sigHeader{ display:flex; align-items:center; justify-content:space-between }
  #sigCanvasWrap{ border:1px dashed var(--brand); border-radius:10px; position:relative; padding:8px }
  #sigCanvas{ width:100%; height:250px; display:block; touch-action:none; background:#fff }
  .sigLine{ position:absolute; left:5%; right:5%; bottom:20px; border-bottom:3px solid #000; opacity:.55; pointer-events:none }
  #sigFooter{ display:flex; gap:10px; justify-content:flex-end }
</style>
</head>
<body>

<!-- 1) PDF preview (desktop embed, mobile PDF.js) -->
<div class="card">
  <div id="desktopPreview">
    <embed id="pdfEmbed" src="template.pdf" type="application/pdf">
  </div>
  <div id="mobilePreview" class="hidden">
    <canvas id="pdfCanvas"></canvas>
  </div>
  <div><button id="btnStartFill" class="btn primary">Vyplniť údaje</button></div>
</div>

<!-- 2) Form (hidden until clicked) -->
<div id="formCard" class="card hidden">
  <div>
    <label for="i_name">Meno a priezvisko</label>
    <input id="i_name" placeholder="Ján Novák">
  </div>
  <div>
    <label for="i_addr">Trvalý pobyt</label>
    <input id="i_addr" placeholder="Ulica 1, 010 01 Mesto">
  </div>
  <div>
    <label for="i_rc">Rodné číslo</label>
    <input id="i_rc" placeholder="XXXXXX/XXXX">
  </div>
  <div style="display:flex; gap:10px">
    <div style="flex:1">
      <label for="i_place">Miesto podpísania</label>
      <input id="i_place" placeholder="Bratislava">
    </div>
    <div style="flex:1">
      <label for="i_date">Dátum</label>
      <input id="i_date" type="date">
    </div>
  </div>
  <div>
    <label for="i_client_email">Email klienta (voliteľné – po podpise pošleme PDF)</label>
    <input id="i_client_email" placeholder="email@example.com">
  </div>
  <div>
    <button id="btnConfirmForm" class="btn primary">Potvrdiť údaje (zobraziť vyplnené PDF)</button>
  </div>
</div>

<!-- 3) Filled PDF (same page, no new tab) -->
<div id="filledCard" class="card hidden">
  <div id="filledDesktop">
    <iframe id="resultFrame"></iframe>
  </div>
  <div id="filledMobile" class="hidden">
    <canvas id="filledCanvas"></canvas>
  </div>
  <div style="display:flex; gap:10px; margin-top:10px">
    <button id="btnSign" class="btn primary">Podpísať</button>
    <a id="btnDownloadFilled" class="btn ghost hidden" download="plna_moc_vyplnena.pdf">Stiahnuť vyplnené PDF</a>
  </div>
</div>

<!-- 4) Signature panel (custom engine, width 100%, height 250px) -->
<div id="sigPanel">
  <div id="sigBox">
    <div id="sigHeader">
      <div><strong>Podpis</strong> – nakreslite na čiaru</div>
      <button id="btnCloseSig" class="btn ghost">Zavrieť</button>
    </div>
    <div id="sigCanvasWrap">
      <div class="sigLine"></div>
      <canvas id="sigCanvas"></canvas>
    </div>
    <div id="sigFooter">
      <button id="btnClearSig" class="btn ghost">Vymazať podpis</button>
      <button id="btnConfirmSig" class="btn primary">Potvrdiť podpis</button>
    </div>
  </div>
</div>

<!-- 5) Final PDF (same page) -->
<div id="finalCard" class="card hidden">
  <div id="finalDesktop">
    <iframe id="finalFrame"></iframe>
  </div>
  <div id="finalMobile" class="hidden">
    <canvas id="finalCanvas"></canvas>
  </div>
  <div style="margin-top:10px">
    <a id="btnDownloadFinal" class="btn primary" download="plna_moc_podpisana.pdf">Stiahnuť podpísané PDF</a>
  </div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
<script>
  // --- EmailJS ---
  emailjs.init("BDiw7IJQiDnlCYFPX");
  const EMAIL_SERVICE_ID = "service_gnniw7e";
  const EMAIL_TEMPLATE_ID = "template_184peha";
  const AGENT_EMAIL      = "m.sunok@protonmail.com";

  // --- Mobile detection ---
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

  // Sections
  const desktopPreview = document.getElementById('desktopPreview');
  const mobilePreview  = document.getElementById('mobilePreview');
  const pdfCanvas      = document.getElementById('pdfCanvas');

  const formCard  = document.getElementById('formCard');
  const filledCard= document.getElementById('filledCard');
  const resultFrame = document.getElementById('resultFrame');
  const filledCanvas= document.getElementById('filledCanvas');

  const finalCard = document.getElementById('finalCard');
  const finalFrame= document.getElementById('finalFrame');
  const finalCanvas= document.getElementById('finalCanvas');

  const btnStartFill = document.getElementById('btnStartFill');
  const btnConfirmForm = document.getElementById('btnConfirmForm');
  const btnSign = document.getElementById('btnSign');
  const btnDownloadFilled = document.getElementById('btnDownloadFilled');
  const btnDownloadFinal  = document.getElementById('btnDownloadFinal');

  // Load initial preview
  if (isMobile) {
    desktopPreview.classList.add('hidden');
    mobilePreview.classList.remove('hidden');
    renderPdfToCanvas('template.pdf', pdfCanvas);
  }

  // State
  let filledPdfBytes = null;
  let finalPdfBytes  = null;

  // Helpers
  function xhrLoadArrayBuffer(url){
    return new Promise((resolve, reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open("GET", url);
      xhr.responseType = "arraybuffer";
      xhr.onload = ()=> resolve(xhr.response);
      xhr.onerror = ()=> reject(new Error("XHR PDF load failed"));
      xhr.send();
    });
  }
  function blobUrl(bytes){ return URL.createObjectURL(new Blob([bytes], {type:"application/pdf"})); }
  function bytesToDataUrl(bytes){
    return new Promise(resolve=>{
      const blob = new Blob([bytes], {type:"application/pdf"});
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result); // data:application/pdf;base64,....
      reader.readAsDataURL(blob);
    });
  }
  async function renderPdfToCanvas(srcOrBytes, canvas){
    const loadingTask = (typeof srcOrBytes === 'string')
      ? pdfjsLib.getDocument(srcOrBytes)
      : pdfjsLib.getDocument({ data: srcOrBytes });
    const pdf = await loadingTask.promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 1.4 });
    const context = canvas.getContext('2d');
    canvas.width  = viewport.width;
    canvas.height = viewport.height;
    await page.render({ canvasContext: context, viewport }).promise;
  }

  // 1) Show form
  btnStartFill.addEventListener('click', ()=>{
    formCard.classList.remove('hidden');
    window.scrollTo({ top: formCard.offsetTop - 8, behavior: 'smooth' });
  });

  // 2) Confirm form -> fill into PDF and show on same page
  btnConfirmForm.addEventListener('click', async ()=>{
    try{
      const existingPdfBytes = await xhrLoadArrayBuffer('template.pdf');

      const { PDFDocument, StandardFonts } = PDFLib;
      const pdfDoc = await PDFDocument.load(existingPdfBytes);
      const page = pdfDoc.getPages()[0];
      const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
      function draw(text, x, y){ page.drawText(text||'', { x, y, size: 11, font }); }

      const name  = document.getElementById('i_name').value;
      const addr  = document.getElementById('i_addr').value;
      const rc    = document.getElementById('i_rc').value;
      const place = document.getElementById('i_place').value;
      const date  = document.getElementById('i_date').value;

      // VARIANTA B – zarovnanie doprava (doladíme spolu, hodnoty sú odhad A4)
      draw(name,  160, 675);
      draw(addr,  160, 655);
      draw(rc,    160, 635);
      draw(place, 160, 515);
      if (date){
        const p = date.split('-');
        draw(p[2]+'.'+p[1]+'.'+p[0], 305, 515);
      }

      filledPdfBytes = await pdfDoc.save();
      if (isMobile) {
        document.getElementById('filledMobile').classList.remove('hidden');
        document.getElementById('filledDesktop').classList.add('hidden');
        await renderPdfToCanvas(filledPdfBytes, filledCanvas);
      } else {
        const url = blobUrl(filledPdfBytes);
        resultFrame.src = url;
        btnDownloadFilled.href = url;
      }
      btnDownloadFilled.classList.remove('hidden');
      filledCard.classList.remove('hidden');
      window.scrollTo({ top: filledCard.offsetTop - 8, behavior: 'smooth' });
    }catch(e){
      alert('Chyba pri generovaní vyplneného PDF: ' + e.message);
    }
  });

  // ===== Custom Signature Engine (smooth quadratic curves) =====
  const sigPanel   = document.getElementById('sigPanel');
  const sigCanvas  = document.getElementById('sigCanvas');
  const btnCloseSig= document.getElementById('btnCloseSig');
  const btnClearSig= document.getElementById('btnClearSig');
  const btnConfirmSig = document.getElementById('btnConfirmSig');

  let ctx = null;
  let drawing = false;
  let points = []; // {x,y}

  function initSigCanvas(){
    ctx = sigCanvas.getContext('2d');
    const cssW = Math.floor(document.getElementById('sigCanvasWrap').clientWidth - 16);
    const cssH = 250;
    // fixed internal resolution for tiny PNG:
    sigCanvas.width  = 500;
    sigCanvas.height = 200;
    sigCanvas.style.width  = cssW + 'px';
    sigCanvas.style.height = cssH + 'px';
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = '#0a58ff';
    ctx.lineWidth = 4.5; // hrubé pero
  }

  function scaleCoord(clientX, clientY){
    const rect = sigCanvas.getBoundingClientRect();
    const x = (clientX - rect.left) * (sigCanvas.width  / rect.width);
    const y = (clientY - rect.top)  * (sigCanvas.height / rect.height);
    return {x,y};
  }

  function smoothDraw(){
    if(points.length < 2) return;
    ctx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    for(let i=1;i<points.length-1;i++){
      const xc = (points[i].x + points[i+1].x)/2;
      const yc = (points[i].y + points[i+1].y)/2;
      ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc);
    }
    ctx.stroke();
  }

  function onPointerDown(e){
    e.preventDefault();
    drawing = true;
    points = [];
    const p = (e.touches ? e.touches[0] : e);
    points.push(scaleCoord(p.clientX, p.clientY));
  }
  function onPointerMove(e){
    if(!drawing) return;
    e.preventDefault();
    const p = (e.touches ? e.touches[0] : e);
    points.push(scaleCoord(p.clientX, p.clientY));
    if(points.length > 1200) points = points.slice(-1200); // throttle
    smoothDraw();
  }
  function onPointerUp(e){
    if(!drawing) return;
    e.preventDefault();
    drawing = false;
    smoothDraw();
  }

  function attachSigEvents(){
    sigCanvas.addEventListener('mousedown', onPointerDown, {passive:false});
    sigCanvas.addEventListener('mousemove', onPointerMove, {passive:false});
    document.addEventListener('mouseup', onPointerUp, {passive:false});

    sigCanvas.addEventListener('touchstart', onPointerDown, {passive:false});
    sigCanvas.addEventListener('touchmove', onPointerMove, {passive:false});
    sigCanvas.addEventListener('touchend', onPointerUp, {passive:false});
  }

  document.getElementById('btnSign').addEventListener('click', ()=>{
    sigPanel.style.display = 'flex';
    initSigCanvas();
    attachSigEvents();
  });

  document.getElementById('btnCloseSig').addEventListener('click', ()=>{
    sigPanel.style.display = 'none';
  });

  document.getElementById('btnClearSig').addEventListener('click', ()=>{
    points = [];
    initSigCanvas();
  });

  // SAFE: convert dataURL -> Uint8Array
  function dataURLtoUint8(dataURL){
    const base64 = dataURL.split(',')[1];
    const binary = atob(base64);
    const len = binary.length;
    const bytes = new Uint8Array(len);
    for(let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
    return bytes;
  }

  // 4) Confirm signature -> final PDF (same page), send emails
  btnConfirmSig.addEventListener('click', async ()=>{
    try{
      if(points.length < 5){ alert('Podpis chýba.'); return; }
      const sigDataUrl = sigCanvas.toDataURL('image/png'); // tiny PNG (500x200)
      const sigBytes = dataURLtoUint8(sigDataUrl);         // <-- byty

      const { PDFDocument } = PDFLib;
      const pdfDoc = await PDFDocument.load(filledPdfBytes);
      const page = pdfDoc.getPages()[0];

      const sigImg = await pdfDoc.embedPng(sigBytes);      // <-- vkladáme byty
      page.drawImage(sigImg, {
        x: 365,
        y: 458,
        width: 185,
        height: 77
      });

      finalPdfBytes = await pdfDoc.save();

      if (isMobile) {
        document.getElementById('finalMobile').classList.remove('hidden');
        document.getElementById('finalDesktop').classList.add('hidden');
        await renderPdfToCanvas(finalPdfBytes, finalCanvas);
      } else {
        const url = blobUrl(finalPdfBytes);
        finalFrame.src = url;
        document.getElementById('btnDownloadFinal').href = url;
      }
      document.getElementById('finalCard').classList.remove('hidden');
      sigPanel.style.display = 'none';
      window.scrollTo({ top: finalCard.offsetTop - 8, behavior: 'smooth' });

      // Email (agent + optional client) – asynchrónne
      const dataUrl = await bytesToDataUrl(finalPdfBytes);
      const base64 = dataUrl.split(',')[1] || '';
      const params = {
        client_email: (document.getElementById('i_client_email').value || '').trim(),
        agent_email:  AGENT_EMAIL,
        pdf_file:     base64,
        client_name:  document.getElementById('i_name').value
      };
      setTimeout(()=>{
        emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, params).catch(()=>{});
      },0);
    }catch(e){
      alert('Chyba pri finálnom podpise: ' + e.message);
    }
  });
</script>
</body>
</html>
