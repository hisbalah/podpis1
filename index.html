<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plná moc – podpis (v9)</title>
<style>
  :root{ --brand:#0a58ff; }
  *{ box-sizing:border-box }
  body{ font-family:system-ui, Arial, sans-serif; margin:16px; color:#111 }
  .btn{ display:inline-block; padding:12px 16px; border-radius:10px; border:1px solid #d0d7ff; background:#eef3ff; color:#0a2cff; cursor:pointer; font-weight:700; margin-top:12px }
  .btn.primary{ background:var(--brand); border-color:var(--brand); color:#fff }
  .btn.ghost{ background:#fff; border-color:#ccc; color:#333 }
  .card{ border:1px solid #e5e7eb; border-radius:14px; padding:14px; background:#fff; margin-bottom:12px }
  .hidden{ display:none !important }
  label{ display:block; font-weight:600; margin:10px 0 6px }
  input{ width:100%; padding:10px; border:1px solid #c9c9c9; border-radius:8px; font-size:16px }
  #pdfEmbed{ width:100%; height:540px; border:1px solid #d1d5db; border-radius:10px }
  #pdfCanvas, #finalCanvas, #filledCanvas{ width:100%; height:auto; border:1px solid #d1d5db; border-radius:10px }
  #resultFrame, #finalFrame{ width:100%; height:560px; border:1px solid #333; border-radius:10px }
  /* Fullscreen signature modal */
  #sigModal{ position:fixed; inset:0; background:rgba(0,0,0,.18); display:none; align-items:center; justify-content:center; z-index:9999 }
  #sigWrap{ background:#fff; width:96vw; height:92vh; display:flex; flex-direction:column; gap:10px; border-radius:14px; box-shadow:0 12px 40px rgba(0,0,0,.25); padding:10px }
  #sigHeader{ display:flex; align-items:center; justify-content:space-between }
  #sigCanvas{ flex:1; border:1px dashed var(--brand); border-radius:10px; touch-action:none }
  #sigFooter{ display:flex; gap:10px; justify-content:flex-end }
  .sigLine{ position:absolute; left:5%; right:5%; bottom:16%; border-bottom:3px solid #000; opacity:.6; pointer-events:none }
  #sigStage{ position:relative; flex:1; display:flex }
</style>
</head>
<body>

<!-- 1) PDF preview (desktop embed, mobile PDF.js) -->
<div class="card">
  <div id="desktopPreview">
    <embed id="pdfEmbed" src="template.pdf" type="application/pdf">
  </div>
  <div id="mobilePreview" class="hidden">
    <canvas id="pdfCanvas"></canvas>
  </div>
  <div><button id="btnStartFill" class="btn primary">Vyplniť údaje</button></div>
</div>

<!-- 2) Form (hidden until clicked) -->
<div id="formCard" class="card hidden">
  <div>
    <label for="i_name">Meno a priezvisko</label>
    <input id="i_name" placeholder="Ján Novák">
  </div>
  <div>
    <label for="i_addr">Trvalý pobyt</label>
    <input id="i_addr" placeholder="Ulica 1, 010 01 Mesto">
  </div>
  <div>
    <label for="i_rc">Rodné číslo</label>
    <input id="i_rc" placeholder="XXXXXX/XXXX">
  </div>
  <div style="display:flex; gap:10px">
    <div style="flex:1">
      <label for="i_place">Miesto podpísania</label>
      <input id="i_place" placeholder="Bratislava">
    </div>
    <div style="flex:1">
      <label for="i_date">Dátum</label>
      <input id="i_date" type="date">
    </div>
  </div>
  <div>
    <label for="i_client_email">Email klienta (voliteľné – po podpise pošleme PDF)</label>
    <input id="i_client_email" placeholder="email@example.com">
  </div>
  <div>
    <button id="btnConfirmForm" class="btn primary">Potvrdiť údaje (zobraziť vyplnené PDF)</button>
  </div>
</div>

<!-- 3) Filled PDF (same page, no new tab) -->
<div id="filledCard" class="card hidden">
  <div id="filledDesktop">
    <iframe id="resultFrame"></iframe>
  </div>
  <div id="filledMobile" class="hidden">
    <canvas id="filledCanvas"></canvas>
  </div>
  <div style="display:flex; gap:10px; margin-top:10px">
    <button id="btnSign" class="btn primary">Podpísať</button>
    <a id="btnDownloadFilled" class="btn ghost hidden" download="plna_moc_vyplnena.pdf">Stiahnuť vyplnené PDF</a>
  </div>
</div>

<!-- 4) Signature modal fullscreen -->
<div id="sigModal">
  <div id="sigWrap">
    <div id="sigHeader">
      <div><strong>Podpis</strong> – nakreslite na čiaru</div>
      <button id="btnCloseSig" class="btn ghost">Zavrieť</button>
    </div>
    <div id="sigStage">
      <div class="sigLine"></div>
      <canvas id="sigCanvas"></canvas>
    </div>
    <div id="sigFooter">
      <button id="btnClearSig" class="btn ghost">Vymazať podpis</button>
      <button id="btnConfirmSig" class="btn primary">Potvrdiť podpis</button>
    </div>
  </div>
</div>

<!-- 5) Final PDF (same page) -->
<div id="finalCard" class="card hidden">
  <div id="finalDesktop">
    <iframe id="finalFrame"></iframe>
  </div>
  <div id="finalMobile" class="hidden">
    <canvas id="finalCanvas"></canvas>
  </div>
  <div style="margin-top:10px">
    <a id="btnDownloadFinal" class="btn primary" download="plna_moc_podpisana.pdf">Stiahnuť podpísané PDF</a>
  </div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
<script>
  // --- EmailJS ---
  emailjs.init("BDiw7IJQiDnlCYFPX");
  const EMAIL_SERVICE_ID = "service_gnniw7e";
  const EMAIL_TEMPLATE_ID = "template_184peha";
  const AGENT_EMAIL      = "m.sunok@protonmail.com";

  // --- Mobile detection ---
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

  // Sections
  const desktopPreview = document.getElementById('desktopPreview');
  const mobilePreview  = document.getElementById('mobilePreview');
  const pdfCanvas      = document.getElementById('pdfCanvas');

  const formCard  = document.getElementById('formCard');
  const filledCard= document.getElementById('filledCard');
  const resultFrame = document.getElementById('resultFrame');
  const filledCanvas= document.getElementById('filledCanvas');

  const finalCard = document.getElementById('finalCard');
  const finalFrame= document.getElementById('finalFrame');
  const finalCanvas= document.getElementById('finalCanvas');

  const btnStartFill = document.getElementById('btnStartFill');
  const btnConfirmForm = document.getElementById('btnConfirmForm');
  const btnSign = document.getElementById('btnSign');
  const btnDownloadFilled = document.getElementById('btnDownloadFilled');
  const btnDownloadFinal  = document.getElementById('btnDownloadFinal');

  // Load initial preview
  if (isMobile) {
    desktopPreview.classList.add('hidden');
    mobilePreview.classList.remove('hidden');
    renderPdfToCanvas('template.pdf', pdfCanvas);
  }

  // State
  let filledPdfBytes = null;
  let finalPdfBytes  = null;
  let signaturePad = null;

  // Helpers
  function xhrLoadArrayBuffer(url){
    return new Promise((resolve, reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open("GET", url);
      xhr.responseType = "arraybuffer";
      xhr.onload = ()=> resolve(xhr.response);
      xhr.onerror = ()=> reject(new Error("XHR PDF load failed"));
      xhr.send();
    });
  }
  function blobUrl(bytes){ return URL.createObjectURL(new Blob([bytes], {type:"application/pdf"})); }
  function bytesToDataUrl(bytes){
    return new Promise(resolve=>{
      const blob = new Blob([bytes], {type:"application/pdf"});
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result); // data:application/pdf;base64,....
      reader.readAsDataURL(blob);
    });
  }
  async function renderPdfToCanvas(srcOrBytes, canvas){
    const loadingTask = (typeof srcOrBytes === 'string')
      ? pdfjsLib.getDocument(srcOrBytes)
      : pdfjsLib.getDocument({ data: srcOrBytes });
    const pdf = await loadingTask.promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 1.4 });
    const context = canvas.getContext('2d');
    canvas.width  = viewport.width;
    canvas.height = viewport.height;
    await page.render({ canvasContext: context, viewport }).promise;
  }

  // 1) Show form
  btnStartFill.addEventListener('click', ()=>{
    formCard.classList.remove('hidden');
    window.scrollTo({ top: formCard.offsetTop - 8, behavior: 'smooth' });
  });

  // 2) Confirm form -> fill into PDF and show on same page
  btnConfirmForm.addEventListener('click', async ()=>{
    try{
      const existingPdfBytes = await xhrLoadArrayBuffer('template.pdf');

      const { PDFDocument, StandardFonts } = PDFLib;
      const pdfDoc = await PDFDocument.load(existingPdfBytes);
      const page = pdfDoc.getPages()[0];
      const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
      function draw(text, x, y){ page.drawText(text||'', { x, y, size: 11, font }); }

      const name  = document.getElementById('i_name').value;
      const addr  = document.getElementById('i_addr').value;
      const rc    = document.getElementById('i_rc').value;
      const place = document.getElementById('i_place').value;
      const date  = document.getElementById('i_date').value;

      // VARIANTA B – zarovnanie doprava (doladíme spolu, hodnoty sú odhad A4)
      draw(name,  160, 675);
      draw(addr,  160, 655);
      draw(rc,    160, 635);
      draw(place, 160, 515);
      if (date){
        const p = date.split('-');
        draw(p[2]+'.'+p[1]+'.'+p[0], 305, 515);
      }

      filledPdfBytes = await pdfDoc.save();
      if (isMobile) {
        document.getElementById('filledMobile').classList.remove('hidden');
        document.getElementById('filledDesktop').classList.add('hidden');
        await renderPdfToCanvas(filledPdfBytes, filledCanvas);
      } else {
        const url = blobUrl(filledPdfBytes);
        resultFrame.src = url;
        btnDownloadFilled.href = url;
      }
      btnDownloadFilled.classList.remove('hidden');
      filledCard.classList.remove('hidden');
      window.scrollTo({ top: filledCard.offsetTop - 8, behavior: 'smooth' });
    }catch(e){
      alert('Chyba pri generovaní vyplneného PDF: ' + e.message);
    }
  });

  // 3) Signature modal
  const sigModal   = document.getElementById('sigModal');
  const sigCanvas  = document.getElementById('sigCanvas');
  const btnCloseSig= document.getElementById('btnCloseSig');
  const btnClearSig= document.getElementById('btnClearSig');
  const btnConfirmSig = document.getElementById('btnConfirmSig');

  btnSign.addEventListener('click', ()=>{
    sigModal.style.display = 'flex';
    // Proper DPR scaling on iOS/Android
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const cssW = Math.floor(window.innerWidth  * 0.94);
    const cssH = Math.floor(window.innerHeight * 0.78);
    sigCanvas.width  = cssW * ratio;
    sigCanvas.height = cssH * ratio;
    sigCanvas.style.width  = cssW + 'px';
    sigCanvas.style.height = cssH + 'px';
    const ctx = sigCanvas.getContext('2d');
    ctx.scale(ratio, ratio);

    signaturePad = new SignaturePad(sigCanvas, {
      penColor: "#0a58ff",
      minWidth: 2.5,   // HRUBÝ podpis
      maxWidth: 4.5
    });
  });

  btnCloseSig.addEventListener('click', ()=>{ sigModal.style.display = 'none'; });
  btnClearSig.addEventListener('click', ()=> signaturePad && signaturePad.clear());

  // 4) Confirm signature -> final PDF (same page), send emails
  btnConfirmSig.addEventListener('click', async ()=>{
    try{
      if (!signaturePad || signaturePad.isEmpty()) { alert('Podpis chýba.'); return; }
      const sigDataUrl = signaturePad.toDataURL();

      const { PDFDocument } = PDFLib;
      const pdfDoc = await PDFDocument.load(filledPdfBytes);
      const page = pdfDoc.getPages()[0];

      // podpis medzi "Splnomocnenec" a bodkovanú čiaru – jemne posunieme podľa reality
      const sigImg = await pdfDoc.embedPng(sigDataUrl);
      page.drawImage(sigImg, {
        x: 365,
        y: 458,
        width: 185,
        height: 88
      });

      finalPdfBytes = await pdfDoc.save();

      if (isMobile) {
        document.getElementById('finalMobile').classList.remove('hidden');
        document.getElementById('finalDesktop').classList.add('hidden');
        await renderPdfToCanvas(finalPdfBytes, finalCanvas);
      } else {
        const url = blobUrl(finalPdfBytes);
        finalFrame.src = url;
        document.getElementById('btnDownloadFinal').href = url;
      }
      document.getElementById('finalCard').classList.remove('hidden');
      sigModal.style.display = 'none';
      window.scrollTo({ top: finalCard.offsetTop - 8, behavior: 'smooth' });

      // Email (agent + optional client) – cez FileReader, bez stack overflow
      const dataUrl = await bytesToDataUrl(finalPdfBytes);
      const base64 = dataUrl.split(',')[1] || '';
      const params = {
        client_email: (document.getElementById('i_client_email').value || '').trim(),
        agent_email:  AGENT_EMAIL,
        pdf_file:     base64,
        client_name:  document.getElementById('i_name').value
      };
      emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, params)
        .then(()=>{})
        .catch(err=>console.warn('EmailJS error:', err));

      // Set download link on mobile too
      if (isMobile) {
        const url = blobUrl(finalPdfBytes);
        document.getElementById('btnDownloadFinal').href = url;
      }
    }catch(e){
      alert('Chyba pri finálnom podpise: ' + e.message);
    }
  });
</script>
</body>
</html>
